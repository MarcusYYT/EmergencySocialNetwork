doctype html
html(lang='en')
  head
    meta(charset='UTF-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    link(href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css', rel='stylesheet', integrity='sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3', crossorigin='anonymous')
    link(rel='stylesheet', href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css')
    link(rel='stylesheet', type='text/css', href='/stylesheets/index.css')
    script(src='/javascripts/directory.js')
    script(src='https://cdn.socket.io/4.7.4/socket.io.min.js')
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    title Directory 
  body
    .navbar.container
      i.bi.bi-plus-circle-fill.col.col-2(onclick='toggleHamburgerMenu()')
      a#logout.btn.btn-primary.col.col-1(onclick='logout()') Log Out
    #hamburgerMenu.links
      a.navLinks(onclick='routeToAnnouncement()') Annoucements
      a.navLinks(onclick='routeToMessageWall()') New Post
      a.navLinks(onclick='routeToTest()') Speed Test
    form#directory-search-form.input-group.mb-3(onsubmit="submitSearch()" onchange="searchFinished()")
        select#search-select.form-select-sm
          option(value='User') User
          option(value='Status') Status
        input#directory-search-input.form-control(type='text', name='search', placeholder='Search...')
    #status-wrapper.dropdown
      button#status-list.btn.btn-primary.dropdown-toggle(type='button' data-bs-toggle='dropdown' aria-expanded='false')
        | Change Status
      #dropdown-wrapper
        ul.dropdown-menu#status-dropdown
          li#ok-status.status-options
            p.status-item.dropdown-item OK
            i.bi.bi-check-circle-fill
          li#help-status.status-options
            p.status-item.dropdown-item Help
            i.bi.bi-exclamation-circle-fill
          li#emergency-status.status-options
            p.status-item.dropdown-item Emergency
            i.bi.bi-bandaid-fill
    #directory-wrapper
      h1#directory-header ESN Directory
      #directory.container
    #overlayForTest(style='display: none;')
      p Currently Speed Testing... 
      p Don't Close the Browser Tab...

    script.
      const socket = io();
      let username = '';

      socket.on('connect', async function() {
        console.log('Connected to server');
        console.log('Socket ID:', socket.id);
        const userId = #{user_id};
        await fetch(`/sockets`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({user_id: userId, socket_id: socket.id, operation:'register'})})
                .then(response => response.json())
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('Error register socket:', error);
            });
      })

      async function submitSearch() {
        event.preventDefault()
        let selectElement = document.getElementById('search-select');
        let selectedValue = selectElement.value;

        let searchInput = document.getElementById('directory-search-input');
        let searchValue = searchInput.value;

        const userId = #{user_id}
        await fetch(`/search?q=${searchValue}&domain=${selectedValue}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        }).then(response => response.json()).then( async (data) => {
          await fetch(`/privatePosts/unread/${userId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          }).then(response => response.json()).then((unRead) => {
            console.log('unread message status: ')
            console.log(unRead)
            // implement to display the notification
            renderESNList(sortUsers(data.data),unRead.data)
          })
        }).catch(error => {
          console.error(error);
        })
      }

      async function searchFinished(){

        let searchInput = document.getElementById('directory-search-input');
        let searchValue = searchInput.value;

        if (searchValue === ""){
          const userId = #{user_id}
            await getUsers().then(response => response.json()).then(async (data)=>{
              await fetch(`/privatePosts/unread/${userId}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
              }).then(response => response.json()).then((unRead) => {
                console.log('unread message status: ')
                console.log(unRead)
                // implement to display the notification
                renderESNList(sortUsers(data.data),unRead.data)
              })
          });
        }
      }
  
      window.onload = async function() {
        const userId = #{user_id}
        addEventListenerstoStatus();
        const response = await fetch(`/users/${userId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(response => response.json()).then((data) => {
          username = data.data[0].username;
          renderMyStatus(username, data.data[0].status)
        })
      }

      async function getUsers(){
        return await fetch('/users')
      }

      function sortUsers(data){
        let online = []
        let offline = []

        for (let i = 0; i < data.length; i++) {
            if (data[i].online_status === "online") {
                online.push(data[i])
            }
            else {
                offline.push(data[i])
            }
        }

        online.sort(function (a, b) {
            return a.username.localeCompare(b.username)
        })

        offline.sort(function (a, b) {
            return a.username.localeCompare(b.username)
        })

        return online.concat(offline)
      }

      function renderESNList(list, unread) {
        const userId = #{user_id}
        let directory = document.getElementById("directory");
        while(directory.firstChild){
          directory.removeChild(directory.lastChild);
        }
        let userToUnreadCount = new Map();
        for(let i = 0; i < unread.length; i++){
          console.log(unread.unreadCount)
          userToUnreadCount.set(unread[i].sender.id, unread[i].unreadCount);
        }

        if(list.length == 0){
          let emptyMessage = document.createElement("h1")
          let emptyMessageText = document.createTextNode("No results found")
          emptyMessage.className = 'empty-message'
          emptyMessage.appendChild(emptyMessageText)
          directory.appendChild(emptyMessage);
        }
      
        for (let i = 0; i < list.length; i++) {
          let userDiv = document.createElement("div");
          userDiv.setAttribute("class", "directory-user row gx-1 justify-content-between");
          userDiv.addEventListener("click", () => {routeToPrivateChat(userId, list[i].user_id)})

          let usernameField = document.createElement("p");
          usernameField.setAttribute("class", "usernameField col-10");
          let usernameFieldText = document.createTextNode(list[i].username);
          usernameField.appendChild(usernameFieldText);

          let onlineStatusField = document.createElement("div");
          onlineStatusField.setAttribute("class", "onlineStatusField col-1");

          let onlineStatusFieldImage = document.createElement("i");
          onlineStatusFieldImage.setAttribute("class", "bi bi-record-fill");

          if (list[i].online_status === "online") {
            onlineStatusField.classList.add("online");
          }
          else {
            onlineStatusField.classList.add("offline");
          }

          onlineStatusField.appendChild(onlineStatusFieldImage);

          let statusField = document.createElement("div");
          statusField.setAttribute("class", "statusField col-1");

          let statusFieldImage = document.createElement("i");

          if(list[i].status == "OK"){
            statusFieldImage.setAttribute("class", "bi bi-check-circle-fill");
          }
          else if(list[i].status == "emergency"){
            statusFieldImage.setAttribute("class", "bi bi-bandaid-fill");  
          }
          else if(list[i].status == "help"){
            statusFieldImage.setAttribute("class", "bi bi-exclamation-circle-fill");
          }


          statusField.appendChild(statusFieldImage);
          userDiv.appendChild(onlineStatusField);
          userDiv.appendChild(usernameField);

          if(userToUnreadCount.has(list[i].user_id)){
            console.log(userToUnreadCount)
            let count = userToUnreadCount.get((list[i].user_id))
            let countDisplayValue = count;
            let unReadField = document.createElement("div");
            unReadField.setAttribute("class", "unReadField position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger");

            let unReadCount = document.createTextNode(countDisplayValue)
            unReadField.appendChild(unReadCount)
            userDiv.appendChild(unReadField);
          }

          userDiv.appendChild(statusField);

          directory.appendChild(userDiv);
        }
      }

      
      function addEventListenerstoStatus(){
          let okStatus = document.getElementById("ok-status");
          let helpStatus = document.getElementById("help-status");
          let emergencyStatus = document.getElementById("emergency-status");

          okStatus.addEventListener("click", () => {changeMyStatus("OK")})
          helpStatus.addEventListener("click", () => {changeMyStatus("help")})
          emergencyStatus.addEventListener("click", () => {changeMyStatus("emergency")})
      }

      async function changeMyStatus(selectedValue) {
        const userId = #{user_id};
        const requestBody = {
          user_id: userId,
          updateAt: "status",
          updateValue: selectedValue
        }
        await fetch('/status', {
          method: 'POST', 
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({user_id: userId, status: selectedValue}),
        }) .then(response => response.json())
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('Error push status history', error);
            });

        const updateStatus = await fetch(`/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody),
          })
          
          if(updateStatus.ok){
              const fetchUser = await getUsers()
              if(fetchUser.ok){
                const data = await fetchUser.json();
                console.log(data)

                await fetch(`/privatePosts/unread/${userId}`, {
                  method: 'GET',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  }).then(response => response.json()).then((unRead) => {
                    // implement to display the notification
                    renderESNList(sortUsers(data.data),unRead.data)
                })
              
              }
          }
         
        renderMyStatus(username, selectedValue);       
      }

      socket.on("status_update", async ()=> { 
        const userId = #{user_id}
        await getUsers().then(response => response.json()).then(async (data)=>{
          await fetch(`/privatePosts/unread/${userId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          }).then(response => response.json()).then((unRead) => {
            console.log('unread message status: ')
            console.log(unRead)
            // implement to display the notification
            renderESNList(sortUsers(data.data),unRead.data)
          })

        });
      });

      //- socket.on("newMessage", async (res) => {
      //-   alert(`${res.senderName} sent you a new message`)
      //- })

      function toggleHamburgerMenu() {
        let hamburgerMenu = document.getElementById("hamburgerMenu");
        let overlay = document.createElement("div");
        overlay.setAttribute("id", "overlay")
        let body = document.getElementsByTagName("body")[0]
        let statusWrapper = document.getElementById("status-wrapper")
        
        if (hamburgerMenu.style.display === "flex") {
          hamburgerMenu.style.display = "none";
          document.getElementById("overlay").remove()
        } 
        
        else {
          hamburgerMenu.style.display = "flex";
          body.insertBefore(overlay, statusWrapper)
        }
      }

      function routeToAnnouncement() {
        const user_id = #{user_id};
        window.location.href = `/announcements/${user_id}`;
      }

      function routeToMessageWall() {
        const user_id = #{user_id};
        window.location.href = `/messageWall/${user_id}`;
      }
      function routeToTest() {
        const user_id = #{user_id};
        window.location.href = `/test`;
      }
      
      async function logout(){
        const userId = #{user_id};
        const requestBody = {
          user_id: userId,
          updateAt: "online_status",
          updateValue: "offline"
        }
        await fetch(`/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Performance-Test': 'true'
          },
          body: JSON.stringify(requestBody),
        }).then(response=> response.json()).then((data)=>{
          console.log(data.message)
        })

        window.location.href = `/`
      }

      function showOverlay() {
        document.getElementById('overlayForTest').style.display = 'flex';
      }

      function hideOverlay() {
        document.getElementById('overlayForTest').style.display = 'none';
      }

      socket.on("testMode", () => {
            showOverlay();
      });

      socket.on("testFinish", () => {
            hideOverlay();
      });

    
